#include "stm32f4xx.h"
#include "initialisation.h"
#include <cmath>
#include <cstdlib>

// LUT sizes are probably all going to be constant
#define LUTSIZE 1024

// used to adjust pitch of oscillator two relative to oscillator one
enum RelativePitch {
	NONE,
	OCTAVEDOWN,
	OCTAVEUP,
	SPREAD
};

extern uint32_t SystemCoreClock;
uint32_t SysTickCounter = 0;
int DacOutput = 0;
bool DacRead = false;
bool RingModOn = false;
bool ButtonDown = false;
volatile float freq1 = 440;
volatile float freq2 = 440;
volatile uint16_t Pitch;
volatile float PhaseDist = 0.0f;
volatile float SamplePos1 = 0;
volatile float SamplePos2 = 0;
volatile float PDScale = 0.0f;
volatile uint32_t overrun;
volatile float oldSamplePos = 0;
volatile uint8_t PDLut1 = 0;		// Which PD LUT is being used for DAC1
volatile float SelPDLut1 = 0;
volatile uint8_t PDLut2 = 0;		// Which PD LUT is being used for DAC2
float SineLUT[LUTSIZE];
float TriLUT[LUTSIZE];
float CTriLUT[LUTSIZE];
float PitchLUT[LUTSIZE];

extern volatile uint16_t ADC_array[ADC_BUFFER_LENGTH];
uint8_t adcChannel = 0;

const float PDSquareLUT[] = {0,0.000182,0.000446,0.000789,0.001206,0.001693,0.002248,0.002868,0.003549,0.004290,0.005087,0.005938,0.006841,0.007794,0.008795,0.009843,0.010935,0.012072,0.013250,0.014470,0.015730,0.017029,0.018366,0.019742,0.021155,0.022605,0.024091,0.025615,0.027175,0.028771,0.030405,0.032076,0.033786,0.035534,0.037322,0.039150,0.041021,0.042935,0.044895,0.046903,0.048960,0.051070,0.053237,0.055463,0.057754,0.060114,0.062551,0.065071,0.067684,0.070402,0.073238,0.082960,0.092174,0.100907,0.109182,0.117021,0.124446,0.131478,0.138135,0.144436,0.150398,0.156039,0.161373,0.166417,0.171183,0.175687,0.179939,0.183954,0.187742,0.191315,0.194682,0.197855,0.200842,0.203653,0.206296,0.208779,0.211110,0.213297,0.215346,0.217264,0.219058,0.220733,0.222295,0.223750,0.225102,0.226357,0.227520,0.228594,0.229584,0.230495,0.231329,0.232090,0.232783,0.233410,0.233974,0.234478,0.234926,0.235319,0.235660,0.235953,0.236198,0.236399,0.236557,0.236674,0.236753,0.236794,0.236800,0.236773,0.236713,0.236623,0.236503,0.236356,0.236182,0.235982,0.235758,0.235511,0.235242,0.234951,0.234640,0.234310,0.233961,0.233595,0.233211,0.232812,0.232396,0.231966,0.231522,0.231064,0.230593,0.230109,0.229614,0.229107,0.228589,0.228060,0.227521,0.226973,0.226415,0.225848,0.225272,0.224688,0.224096,0.223497,0.222890,0.222276,0.221655,0.221028,0.220394,0.219754,0.219108,0.218456,0.217799,0.217137,0.216469,0.215797,0.215120,0.214438,0.213751,0.213061,0.212366,0.211667,0.210964,0.210257,0.209547,0.208833,0.208115,0.207394,0.206670,0.205943,0.205212,0.204479,0.203742,0.203003,0.202261,0.201516,0.200769,0.200018,0.199266,0.198511,0.197753,0.196993,0.196231,0.195467,0.194700,0.193932,0.193161,0.192388,0.191613,0.190836,0.190057,0.189276,0.188494,0.187709,0.186923,0.186135,0.185346,0.184554,0.183761,0.182966,0.182170,0.181372,0.180573,0.179772,0.178969,0.178165,0.177360,0.176553,0.175745,0.174935,0.174124,0.173311,0.172497,0.171682,0.170866,0.170048,0.169229,0.168409,0.167587,0.166765,0.165941,0.165115,0.164289,0.163462,0.162633,0.161803,0.160972,0.160140,0.159307,0.158473,0.157638,0.156801,0.155964,0.155126,0.154286,0.153446,0.152604,0.151762,0.150918,0.150074,0.149228,0.148382,0.147535,0.146686,0.145837,0.144987,0.144136,0.143284,0.142431,0.141577,0.140723,0.139867,0.139011,0.138154,0.137296,0.136437,0.135577,0.134716,0.133855,0.132993,0.132130,0.131266,0.130401,0.129536,0.128670,0.127803,0.126935,0.126067,0.125198,0.124328,0.123457,0.122586,0.121713,0.120841,0.119967,0.119093,0.118218,0.117342,0.116466,0.115588,0.114711,0.113832,0.112953,0.112073,0.111193,0.110312,0.109430,0.108548,0.107665,0.106781,0.105897,0.105012,0.104126,0.103240,0.102353,0.101466,0.100578,0.099689,0.098800,0.097911,0.097020,0.096129,0.095238,0.094346,0.093453,0.092560,0.091666,0.090772,0.089877,0.088982,0.088086,0.087189,0.086292,0.085395,0.084497,0.083598,0.082699,0.081799,0.080899,0.079999,0.079097,0.078196,0.077294,0.076391,0.075488,0.074584,0.073680,0.072776,0.071871,0.070965,0.070059,0.069153,0.068246,0.067338,0.066430,0.065522,0.064614,0.063704,0.062795,0.061885,0.060974,0.060063,0.059152,0.058240,0.057328,0.056415,0.055502,0.054589,0.053675,0.052761,0.051846,0.050931,0.050015,0.049100,0.048183,0.047267,0.046350,0.045432,0.044514,0.043596,0.042677,0.041759,0.040839,0.039919,0.038999,0.038079,0.037158,0.036237,0.035315,0.034394,0.033471,0.032549,0.031626,0.030703,0.029779,0.028855,0.027931,0.027006,0.026081,0.025156,0.024230,0.023304,0.022378,0.021451,0.020524,0.019597,0.018669,0.017741,0.016813,0.015885,0.014956,0.014027,0.013097,0.012168,0.011238,0.010307,0.009377,0.008446,0.007514,0.006583,0.005651,0.004719,0.003787,0.002854,0.001921,0.000988,0.000054,-0.000879,-0.001813,-0.002748,-0.003682,-0.004617,-0.005552,-0.006488,-0.007423,-0.008359,-0.009295,-0.010232,-0.011168,-0.012105,-0.013042,-0.013980,-0.014918,-0.015855,-0.016794,-0.017732,-0.018671,-0.019610,-0.020549,-0.021488,-0.022428,-0.023368,-0.024308,-0.025248,-0.026188,-0.027129,-0.028070,-0.029011,-0.029953,-0.030895,-0.031836,-0.032779,-0.033721,-0.034663,-0.035606,-0.036549,-0.037492,-0.038436,-0.039379,-0.040323,-0.041267,-0.042211,-0.043156,-0.044100,-0.045045,-0.045990,-0.046935,-0.047881,-0.048827,-0.049772,-0.050718,-0.051665,-0.052611,-0.053558,-0.054504,-0.055451,-0.056398,-0.057346,-0.058293,-0.059241,-0.060189,-0.061137,-0.062085,-0.063034,-0.063982,-0.064931,-0.065880,-0.066829,-0.067778,-0.068728,-0.069677,-0.070627,-0.071577,-0.072527,-0.073478,-0.074428,-0.075379,-0.076330,-0.077280,-0.078232,-0.079183,-0.080134,-0.081086,-0.063555,-0.046950,-0.031223,-0.016332,-0.002234,0.011110,0.023738,0.035686,0.046988,0.057675,0.067780,0.077330,0.086354,0.094879,0.102928,0.110525,0.117694,0.124456,0.130831,0.136838,0.142496,0.147823,0.152834,0.157546,0.161973,0.166130,0.170031,0.173688,0.177113,0.180317,0.183313,0.186111,0.188719,0.191148,0.193407,0.195505,0.197448,0.199246,0.200904,0.202431,0.203833,0.207383,0.210757,0.213962,0.217005,0.219895,0.222636,0.225235,0.227699,0.230034,0.232244,0.234335,0.236313,0.238183,0.239948,0.241613,0.243184,0.244663,0.246055,0.247363,0.248592,0.249744,0.250823,0.251831,0.252773,0.253650,0.254466,0.255223,0.255924,0.256570,0.257165,0.257710,0.258208,0.258660,0.259069,0.259436,0.259762,0.260050,0.260301,0.260517,0.260699,0.260849,0.260967,0.261055,0.261114,0.261146,0.261151,0.261130,0.261086,0.261017,0.260926,0.260813,0.260679,0.260525,0.260352,0.260160,0.259950,0.259722,0.259478,0.259218,0.258943,0.258653,0.258348,0.258029,0.257697,0.257352,0.256995,0.256626,0.256245,0.255852,0.255449,0.255036,0.254612,0.254179,0.253735,0.253283,0.252822,0.252352,0.251874,0.251388,0.250894,0.250392,0.249883,0.249367,0.248844,0.248314,0.247777,0.247234,0.246685,0.246130,0.245569,0.245002,0.244430,0.243852,0.243269,0.242680,0.242087,0.241489,0.240886,0.240278,0.239666,0.239050,0.238429,0.237804,0.237174,0.236541,0.235904,0.235262,0.234617,0.233969,0.233316,0.232660,0.232001,0.231338,0.230672,0.230003,0.229330,0.228654,0.227975,0.227293,0.226608,0.225921,0.225230,0.224536,0.223840,0.223141,0.222439,0.221735,0.221028,0.220318,0.219606,0.218891,0.218174,0.217455,0.216733,0.216009,0.215283,0.214554,0.213823,0.213090,0.212355,0.211618,0.210879,0.210137,0.209394,0.208648,0.207900,0.207151,0.206400,0.205646,0.204891,0.204134,0.203375,0.202614,0.201852,0.201087,0.200321,0.199554,0.198784,0.198013,0.197240,0.196466,0.195690,0.194912,0.194133,0.193352,0.192569,0.191785,0.191000,0.190213,0.189424,0.188634,0.187843,0.187050,0.186256,0.185460,0.184663,0.183864,0.183064,0.182263,0.181461,0.180657,0.179852,0.179045,0.178237,0.177428,0.176618,0.175806,0.174993,0.174179,0.173364,0.172548,0.171730,0.170911,0.170091,0.169270,0.168448,0.167624,0.166800,0.165974,0.165147,0.164319,0.163490,0.162660,0.161829,0.160997,0.160164,0.159329,0.158494,0.157658,0.156820,0.155982,0.155143,0.154302,0.153461,0.152619,0.151776,0.150931,0.150086,0.149240,0.148393,0.147545,0.146697,0.145847,0.144996,0.144145,0.143292,0.142439,0.141585,0.140730,0.139874,0.139017,0.138160,0.137301,0.136442,0.135582,0.134721,0.133860,0.132997,0.132134,0.131270,0.130405,0.129540,0.128673,0.127806,0.126938,0.126070,0.125200,0.124330,0.123460,0.122588,0.121716,0.120843,0.119969,0.119095,0.118220,0.117344,0.116467,0.115590,0.114712,0.113834,0.112955,0.112075,0.111194,0.110313,0.109431,0.108549,0.107666,0.106782,0.105898,0.105013,0.104127,0.103241,0.102354,0.101467,0.100579,0.099690,0.098801,0.097911,0.097021,0.096130,0.095238,0.094346,0.093454,0.092560,0.091667,0.090772,0.089877,0.088982,0.088086,0.087190,0.086293,0.085395,0.084497,0.083598,0.082699,0.081800,0.080899,0.079999,0.079098,0.078196,0.077294,0.076391,0.075488,0.074584,0.073680,0.072776,0.071871,0.070965,0.070059,0.069153,0.068246,0.067338,0.066431,0.065522,0.064614,0.063704,0.062795,0.061885,0.060974,0.060063,0.059152,0.058240,0.057328,0.056415,0.055502,0.054589,0.053675,0.052761,0.051846,0.050931,0.050015,0.049100,0.048183,0.047267,0.046350,0.045432,0.044514,0.043596,0.042678,0.041759,0.040839,0.039920,0.038999,0.038079,0.037158,0.036237,0.035315,0.034394,0.033471,0.032549,0.031626,0.030703,0.029779,0.028855,0.027931,0.027006,0.026081,0.025156,0.024230,0.023304,0.022378,0.021451,0.020524,0.019597,0.018669,0.017741,0.016813,0.015885,0.014956,0.014027,0.013097,0.012168,0.011238,0.010307,0.009377,0.008446,0.007514,0.006583,0.005651,0.004719,0.003787,0.002854,0.001921,0.000988,0.000054,-0.000879,-0.001813,-0.002748,-0.003682,-0.004617,-0.005552,-0.006488,-0.007423,-0.008359,-0.009295,-0.010232,-0.011168,-0.012105,-0.013042,-0.013980,-0.014918,-0.015855,-0.016794,-0.017732,-0.018671,-0.019610,-0.020549,-0.021488,-0.022428,-0.023368,-0.024308,-0.025248,-0.026188,-0.027129,-0.028070,-0.029011,-0.029953,-0.030895,-0.031836,-0.032779,-0.033721,-0.034663,-0.035606,-0.036549,-0.037492,-0.038436,-0.039379,-0.040323,-0.041267,-0.042211,-0.043156,-0.044100,-0.045045,-0.045990,-0.046935,-0.047881,-0.048827,-0.049772,-0.050718,-0.051665,-0.053305,-0.054738,-0.055980,-0.057042,-0.057938,-0.058679,-0.059275,-0.059737,-0.060073,-0.060292,-0.060402,-0.060410,-0.060325,-0.060151,-0.059895,-0.059562,-0.059159,-0.058690,-0.058159,-0.057571,-0.056930,-0.056239,-0.055502,-0.054723,-0.053905,-0.053049,-0.052160,-0.051238,-0.050288,-0.049311,-0.048308,-0.047282,-0.046235,-0.045167,-0.044082,-0.042979,-0.041860,-0.040727,-0.039581,-0.038422,-0.037252,-0.036071,-0.034880,-0.033680,-0.032472,-0.031255,-0.030032,-0.028802,-0.027565,-0.026322,-0.025074,0};


//const float PDSawLUT[] = {0.071079,0.070583,0.070087,0.069590,0.069094,0.068597,0.068099,0.067602,0.067104,0.066606,0.066108,0.065609,0.065110,0.064611,0.064112,0.063612,0.063113,0.062612,0.062112,0.061612,0.061111,0.060610,0.060109,0.059607,0.059105,0.058604,0.058101,0.057599,0.057096,0.056593,0.056090,0.055587,0.055084,0.054580,0.054076,0.053572,0.053067,0.052563,0.052058,0.051553,0.051047,0.050542,0.050036,0.049530,0.049024,0.048518,0.048011,0.047504,0.046997,0.046490,0.045983,0.045475,0.044967,0.044459,0.043951,0.043443,0.042934,0.042425,0.041916,0.041407,0.040898,0.040388,0.039878,0.039368,0.038858,0.038348,0.037837,0.037327,0.036816,0.036305,0.035793,0.035282,0.034770,0.034258,0.033746,0.033234,0.032722,0.032209,0.031696,0.031183,0.030670,0.030157,0.029644,0.029130,0.028616,0.028102,0.027588,0.027074,0.026560,0.026045,0.025530,0.025015,0.024500,0.023985,0.023469,0.022954,0.022438,0.021922,0.021406,0.020890,0.020373,0.019857,0.019340,0.018823,0.018306,0.017789,0.017271,0.016754,0.016236,0.015718,0.015200,0.014682,0.014164,0.013646,0.013127,0.012608,0.012090,0.011571,0.011051,0.010532,0.010013,0.009493,0.008974,0.008454,0.007934,0.007414,0.006893,0.006373,0.005852,0.005332,0.004811,0.004290,0.003769,0.003248,0.002726,0.002205,0.001683,0.001162,0.000640,0.000118,-0.000404,-0.000927,-0.001449,-0.001972,-0.002494,-0.003017,-0.003540,-0.004063,-0.004586,-0.005109,-0.005633,-0.006156,-0.006680,-0.007203,-0.007727,-0.008251,-0.008775,-0.009299,-0.009824,-0.010348,-0.010873,-0.011397,-0.011922,-0.012447,-0.012972,-0.013497,-0.014022,-0.014548,-0.015073,-0.015599,-0.016124,-0.016650,-0.017176,-0.017702,-0.018228,-0.018754,-0.019281,-0.019807,-0.020333,-0.020860,-0.021387,-0.021914,-0.022440,-0.022967,-0.023495,-0.024022,-0.024549,-0.025077,-0.025604,-0.026132,-0.026659,-0.027187,-0.027715,-0.028243,-0.028771,-0.029299,-0.029828,-0.030356,-0.030884,-0.031413,-0.031941,-0.032470,-0.032999,-0.033528,-0.034057,-0.034586,-0.035115,-0.035644,-0.036174,-0.036703,-0.037233,-0.037762,-0.038292,-0.038822,-0.039351,-0.039881,-0.040411,-0.040942,-0.041472,-0.042002,-0.042532,-0.043063,-0.043593,-0.044124,-0.044654,-0.045185,-0.045716,-0.046247,-0.046778,-0.047309,-0.047840,-0.048371,-0.048902,-0.049433,-0.049965,-0.050496,-0.051028,-0.051559,-0.052091,-0.052623,-0.053155,-0.053687,-0.054219,-0.054751,-0.055283,-0.055815,-0.056347,-0.056879,-0.057412,-0.057944,-0.058476,-0.059009,-0.059542,-0.060074,-0.060607,0.061140,0.059719,0.058299,0.056879,0.055459,0.054039,0.052619,0.051199,0.049779,0.048359,0.046940,0.045520,0.044100,0.042681,0.041261,0.039842,0.038422,0.037003,0.035584,0.034164,0.032745,0.031326,0.029907,0.028488,0.027069,0.025650,0.024231,0.022812,0.021393,0.019975,0.018556,0.017137,0.015719,0.014300,0.012882,0.011463,0.010045,0.008626,0.007208,0.005790,0.004371,0.002953,0.001535,0.000117,-0.001301,-0.002719,-0.004137,-0.005555,-0.006973,-0.008391,-0.009809,-0.011227,-0.012645,-0.014062,-0.015480,-0.016898,-0.018315,-0.019733,-0.021150,-0.022568,-0.023985,-0.025403,-0.026820,-0.028238,-0.029655,-0.031072,-0.032490,-0.033907,-0.035324,-0.036741,-0.038159,-0.039576,-0.040993,-0.042410,-0.043827,-0.045244,-0.046661,-0.048078,-0.049495,-0.050912,-0.052329,-0.053746,-0.055163,-0.056579,-0.057996,-0.059413,-0.060830,-0.062247,-0.063663,-0.065080,-0.066497,-0.067913,-0.069330,-0.070747,-0.072163,-0.073580,-0.074996,-0.076413,-0.077829,-0.079246,-0.080662,-0.082079,-0.083495,-0.084912,-0.086328,-0.087745,-0.089161,-0.090577,-0.091994,-0.093410,-0.094826,-0.096243,-0.097659,-0.099075,-0.100492,-0.101908,-0.103324,-0.104741,-0.106157,-0.107573,-0.108989,-0.110406,-0.111822,-0.113238,-0.114654,-0.116070,-0.117487,-0.118903,-0.120319,-0.121735,-0.123151,-0.124568,-0.125984,-0.127400,-0.128816,-0.130232,-0.131649,-0.133065,-0.134481,-0.135587,-0.136124,-0.136661,-0.137198,-0.137735,-0.138272,-0.138809,-0.139346,-0.139883,-0.140420,-0.140957,-0.141494,-0.142031,-0.142568,-0.143104,-0.143641,-0.144178,-0.144715,-0.145252,-0.145789,-0.146326,-0.146863,-0.147400,-0.147936,-0.148473,-0.149010,-0.149547,-0.150084,-0.150620,-0.151157,-0.151694,-0.152231,-0.152768,-0.153304,-0.153841,-0.154378,-0.154914,-0.155451,-0.155988,-0.156524,-0.157061,-0.157598,-0.158134,-0.158671,-0.159207,-0.159744,-0.160280,-0.160817,-0.161353,-0.161890,-0.162426,-0.162963,-0.163499,-0.164035,-0.164572,-0.165108,-0.165644,-0.166181,-0.166717,-0.167253,-0.167789,-0.168325,-0.168862,-0.169398,-0.169934,-0.170470,-0.171006,-0.171542,-0.172078,-0.172614,-0.173150,-0.173686,-0.174221,-0.174757,-0.175293,-0.175829,-0.176365,-0.176900,-0.177436,-0.177972,-0.178507,-0.179043,-0.179578,-0.180114,-0.180649,-0.181185,-0.181720,-0.182256,-0.182791,-0.183326,-0.183861,-0.184397,-0.184932,-0.185467,-0.186002,-0.186537,-0.187072,-0.187607,-0.188142,-0.188677,-0.189212,-0.189746,-0.190281,-0.190816,-0.191351,-0.191885,-0.192420,-0.192954,-0.193489,-0.194023,-0.194558,-0.195092,-0.195626,-0.196160,-0.196695,-0.197229,-0.197763,-0.198297,-0.198831,-0.199365,-0.199899,-0.200432,-0.200966,-0.201500,-0.202034,-0.202567,-0.203101,-0.203634,-0.204168,-0.204701,-0.205235,-0.205768,-0.206301,-0.206834,-0.207367,-0.207900,-0.208433,-0.208966,-0.209499,-0.210032,-0.210565,-0.211097,-0.211630,-0.212163,-0.212695,-0.213227,-0.213760,-0.214292,-0.214824,-0.215357,-0.215889,-0.216421,-0.216953,-0.217485,-0.218016,-0.218548,-0.219080,-0.219611,-0.220143,-0.220674,-0.221206,-0.221737,-0.222268,-0.222800,-0.223331,-0.223862,-0.224393,-0.224924,-0.225454,-0.225985,-0.226516,-0.227046,-0.227577,-0.228107,-0.228638,-0.229168,-0.229698,-0.230228,-0.230758,-0.231288,-0.231818,-0.232348,-0.232878,-0.233407,-0.233937,-0.234466,-0.234996,-0.235525,-0.236054,-0.236583,-0.237112,-0.237641,-0.238170,-0.238699,-0.239227,-0.239756,-0.240284,-0.240813,-0.241341,-0.241869,-0.242397,-0.242925,-0.243453,-0.243981,-0.244509,-0.245036,-0.245564,-0.246091,-0.246619,-0.247146,-0.247673,-0.248200,-0.248727,-0.249254,-0.249781,-0.250307,-0.250834,-0.251360,-0.251887,-0.252413,0.138515,0.130634,0.124759,0.119762,0.115291,0.111181,0.107337,0.103701,0.100232,0.096903,0.093690,0.090579,0.087556,0.084611,0.081735,0.078922,0.076165,0.073459,0.070800,0.068184,0.065607,0.063068,0.060563,0.058090,0.055647,0.053232,0.050844,0.048480,0.046141,0.043823,0.041527,0.039251,0.036994,0.034756,0.032535,0.030331,0.028142,0.025969,0.023811,0.021667,0.019536,0.017419,0.015314,0.013221,0.011140,0.009070,0.007012,0.004963,0.002925,0.000897,-0.001121,-0.003131,-0.005131,-0.007122,-0.009105,-0.011080,-0.013047,-0.015005,-0.016957,-0.018900,-0.020837,-0.022767,-0.024689,-0.026606,-0.028515,-0.030418,-0.032315,-0.034206,-0.036091,-0.037970,-0.039844,-0.041712,-0.043575,-0.045432,-0.047284,-0.049131,-0.050973,-0.052810,-0.054643,-0.056471,-0.058294,-0.060113,-0.061927,-0.063737,-0.065543,-0.067344,-0.069142,-0.070935,-0.072725,-0.074510,-0.076292,-0.078071,-0.079845,-0.081616,-0.083383,-0.085147,-0.086908,-0.088665,-0.090418,-0.092169,-0.093916,-0.095660,-0.097401,-0.099139,-0.100874,-0.102606,-0.104335,-0.106062,-0.107785,-0.109506,-0.111223,-0.112939,-0.114651,-0.116361,-0.118068,-0.119773,-0.121475,-0.123174,-0.124872,-0.126566,-0.128259,-0.129949,-0.131636,-0.133322,-0.135005,-0.136686,-0.138364,-0.140041,-0.141715,-0.143387,-0.145058,-0.146726,-0.148392,-0.150056,-0.151718,-0.153378,-0.155036,-0.156692,-0.158346,-0.159998,-0.161649,-0.163298,-0.164944,-0.166589,-0.168233,-0.169874,-0.171514,-0.173152,-0.174789,-0.176423,-0.178056,-0.179688,-0.181318,0.182946,0.182619,0.182291,0.181962,0.181630,0.181298,0.180964,0.180628,0.180291,0.179952,0.179612,0.179271,0.178928,0.178583,0.178238,0.177891,0.177542,0.177193,0.176842,0.176489,0.176135,0.175780,0.175424,0.175067,0.174708,0.174348,0.173986,0.173624,0.173260,0.172895,0.172529,0.172162,0.171794,0.171424,0.171053,0.170681,0.170308,0.169934,0.169559,0.169183,0.168805,0.168427,0.168047,0.167667,0.167285,0.166902,0.166519,0.166134,0.165748,0.165362,0.164974,0.164585,0.164195,0.163805,0.163413,0.163021,0.162627,0.162233,0.161837,0.161441,0.161044,0.160646,0.160247,0.159847,0.159446,0.159044,0.158642,0.158238,0.157834,0.157429,0.157023,0.156616,0.156208,0.155800,0.155390,0.154980,0.154569,0.154158,0.153745,0.153332,0.152918,0.152503,0.152087,0.151671,0.151254,0.150836,0.150417,0.149998,0.149578,0.149157,0.148735,0.148313,0.147890,0.147466,0.147042,0.146616,0.146191,0.145764,0.145337,0.144909,0.144480,0.144051,0.143621,0.143191,0.142759,0.142328,0.141895,0.141462,0.141028,0.140594,0.140159,0.139723,0.139286,0.138850,0.138412,0.137974,0.137535,0.137096,0.136656,0.136215,0.135774,0.135332,0.134890,0.134447,0.134004,0.133560,0.133115,0.132670,0.132224,0.131778,0.131331,0.130884,0.130436,0.129987,0.129538,0.129089,0.128639,0.128188,0.127737,0.127285,0.126833,0.126380,0.125927,0.125474,0.125019,0.124565,0.124109,0.123654,0.123198,0.122741,0.122284,0.121826,0.121368,0.120909,0.120450,0.119991,0.119531,0.119070,0.118609,0.118148,0.117686,0.117224,0.116761,0.116298,0.115834,0.115370,0.114906,0.114441,0.113975,0.113510,0.113043,0.112577,0.112109,0.111642,0.111174,0.110706,0.110237,0.109768,0.109298,0.108828,0.108358,0.107887,0.107415,0.106944,0.106472,0.105999,0.105527,0.105053,0.104580,0.104106,0.103631,0.103157,0.102682,0.102206,0.101730,0.101254,0.100777,0.100300,0.099823,0.099345,0.098867,0.098389,0.097910,0.097431,0.096951,0.096472,0.095991,0.095511,0.095030,0.094549,0.094067,0.093585,0.093103,0.092620,0.092137,0.091654,0.091171,0.090687,0.090202,0.089718,0.089233,0.088748,0.088262,0.087776,0.087290,0.086804,0.086317,0.085830,0.085342,0.084855,0.084366,0.083878,0.083389,0.082901,0.082411,0.081922,0.081432,0.080942,0.080451,0.079961,0.079470,0.078978,0.078487,0.077995,0.077503,0.077010,0.076517,0.076024,0.075531,0.075038,0.074544,0.074050,0.073555,0.073061,0.072566,0.072070,0.071575};
const float PDSawLUT[] = {-0.000438,-0.000877,-0.001317,-0.001757,-0.002198,-0.002639,-0.003081,-0.003524,-0.003967,-0.004411,-0.004855,-0.005300,-0.005746,-0.006192,-0.006638,-0.007085,-0.007533,-0.007981,-0.008430,-0.008879,-0.009329,-0.009779,-0.010230,-0.010681,-0.011133,-0.011586,-0.012039,-0.012492,-0.012946,-0.013400,-0.013855,-0.014311,-0.014767,-0.015223,-0.015680,-0.016137,-0.016595,-0.017053,-0.017512,-0.017972,-0.018431,-0.018892,-0.019352,-0.019813,-0.020275,-0.020737,-0.021200,-0.021663,-0.022126,-0.022590,-0.023054,-0.023519,-0.023984,-0.024450,-0.024916,-0.025382,-0.025849,-0.026316,-0.026784,-0.027252,-0.027721,-0.028190,-0.028659,-0.029129,-0.029599,-0.030070,-0.030541,-0.031012,-0.031484,-0.031956,-0.032429,-0.032902,-0.033375,-0.033849,-0.034323,-0.034798,-0.035273,-0.035748,-0.036224,-0.036700,-0.037176,-0.037653,-0.038130,-0.038608,-0.039086,-0.039564,-0.040043,-0.040521,-0.041001,-0.041480,-0.041960,-0.042441,-0.042922,-0.043403,-0.043884,-0.044366,-0.044848,-0.045330,-0.045813,-0.046296,-0.046780,-0.047263,-0.047747,-0.048232,-0.048716,-0.049202,-0.049687,-0.050173,-0.050659,-0.051145,-0.051632,-0.052119,-0.052606,-0.053093,-0.053581,-0.054069,-0.054558,-0.055047,-0.055536,-0.056025,-0.056515,-0.057005,-0.057495,-0.057986,-0.058477,-0.058968,-0.059459,-0.059951,-0.060443,-0.060935,-0.061428,-0.061921,-0.062414,-0.062907,-0.063401,-0.063895,-0.064389,-0.064884,-0.065379,-0.065874,-0.066369,-0.066865,-0.067360,-0.067857,-0.068353,-0.068850,-0.069346,-0.069844,-0.070341,-0.070839,-0.071337,-0.071835,-0.072333,-0.072832,-0.073331,-0.073830,-0.074329,-0.074829,-0.075329,-0.075829,-0.076330,-0.076830,-0.077331,-0.077832,-0.078334,-0.078835,-0.079337,-0.079839,-0.080341,-0.080844,-0.081347,-0.081850,-0.082353,-0.082856,-0.083360,-0.083864,-0.084368,-0.084872,-0.085377,-0.085881,-0.086386,-0.086892,-0.087397,-0.087903,-0.088408,-0.088914,-0.089421,-0.089927,-0.090434,-0.090941,-0.091448,-0.091955,-0.092463,-0.092970,-0.093478,-0.093986,-0.094495,-0.095003,-0.095512,-0.096021,-0.096530,-0.097039,-0.097549,-0.098058,-0.098568,-0.099078,-0.099588,-0.100099,-0.100610,-0.101120,-0.101631,-0.102143,-0.102654,-0.103165,-0.103677,-0.104189,-0.104701,-0.105213,-0.105726,-0.106239,-0.106751,-0.107264,-0.107778,-0.108291,-0.108804,-0.109318,-0.109832,-0.110346,-0.110860,-0.111375,-0.111889,-0.112404,-0.112919,-0.113434,-0.113949,-0.114464,-0.114980,-0.115496,-0.116011,-0.116527,-0.117044,-0.117560,-0.118076,-0.118593,-0.119110,-0.119627,-0.120144,-0.120661,-0.121179,-0.121696,-0.122214,-0.122732,-0.123250,-0.123768,-0.124286,0.124805,0.123370,0.121936,0.120502,0.119068,0.117634,0.116200,0.114766,0.113333,0.111900,0.110466,0.109033,0.107600,0.106168,0.104735,0.103302,0.101870,0.100438,0.099006,0.097574,0.096142,0.094710,0.093278,0.091847,0.090416,0.088984,0.087553,0.086122,0.084692,0.083261,0.081830,0.080400,0.078970,0.077539,0.076109,0.074679,0.073250,0.071820,0.070390,0.068961,0.067532,0.066102,0.064673,0.063244,0.061815,0.060387,0.058958,0.057529,0.056101,0.054673,0.053244,0.051816,0.050388,0.048961,0.047533,0.046105,0.044678,0.043250,0.041823,0.040396,0.038969,0.037542,0.036115,0.034688,0.033261,0.031835,0.030408,0.028982,0.027556,0.026129,0.024703,0.023277,0.021852,0.020426,0.019000,0.017575,0.016149,0.014724,0.013298,0.011873,0.010448,0.009023,0.007598,0.006173,0.004749,0.003324,0.001900,0.000475,-0.000949,-0.002374,-0.003798,-0.005222,-0.006646,-0.008070,-0.009494,-0.010917,-0.012341,-0.013765,-0.015188,-0.016612,-0.018035,-0.019458,-0.020881,-0.022304,-0.023727,-0.025150,-0.026573,-0.027996,-0.029419,-0.030841,-0.032264,-0.033686,-0.035108,-0.036531,-0.037953,-0.039375,-0.040797,-0.042219,-0.043641,-0.045063,-0.046485,-0.047906,-0.049328,-0.050750,-0.052171,-0.053593,-0.055014,-0.056435,-0.057856,-0.059278,-0.060699,-0.062120,-0.063541,-0.064961,-0.066382,-0.067803,-0.069224,-0.070644,-0.072065,-0.073485,-0.074906,-0.076326,-0.077747,-0.079167,-0.080587,-0.082007,-0.083427,-0.084847,-0.086267,-0.087687,-0.089107,-0.090527,-0.091946,-0.093366,-0.094786,-0.096205,-0.097625,-0.099044,-0.100463,-0.101883,-0.103302,-0.104721,-0.106140,-0.107560,-0.108979,-0.110398,-0.111817,-0.113236,-0.114655,-0.116073,-0.117492,-0.118911,-0.120330,-0.121748,-0.123167,-0.124585,-0.126004,-0.127422,-0.128841,-0.130259,-0.131677,-0.133096,-0.134514,-0.135932,-0.137350,-0.138768,-0.140186,-0.141604,-0.143022,-0.144440,-0.145858,-0.147276,-0.148694,-0.150112,-0.151530,-0.152947,-0.154365,-0.155783,-0.157200,-0.158618,-0.160035,-0.161453,-0.162870,-0.164288,-0.165705,-0.167123,-0.168540,-0.169957,-0.171375,-0.172792,-0.174209,-0.175626,-0.177043,-0.178461,-0.179878,-0.181295,-0.182712,-0.184129,-0.185546,-0.186963,-0.188380,-0.189797,-0.191214,-0.192630,-0.194047,-0.195464,-0.196881,-0.198298,-0.199714,-0.201131,-0.202548,-0.203965,-0.205381,-0.206798,-0.208214,-0.209631,-0.211048,-0.212464,-0.213881,-0.215297,-0.216714,-0.218130,-0.219547,-0.220963,-0.222380,-0.223796,-0.225213,-0.226629,-0.228045,-0.229462,-0.230878,-0.232295,-0.233711,-0.235127,-0.236544,-0.237960,-0.239376,-0.240792,-0.242209,-0.243625,-0.245041,-0.246457,-0.247874,-0.249290,-0.250706,-0.252122,-0.253539,-0.254955,-0.256371,-0.257787,-0.259203,-0.260620,-0.262036,-0.263452,-0.264868,-0.266284,-0.267700,-0.269117,-0.270533,-0.271949,-0.273365,-0.274047,-0.274584,-0.275121,-0.275658,-0.276195,-0.276732,-0.277268,-0.277805,-0.278342,-0.278879,-0.279416,-0.279953,-0.280490,-0.281027,-0.281564,-0.282101,-0.282638,-0.283175,-0.283712,-0.284248,-0.284785,-0.285322,-0.285859,-0.286396,-0.286933,-0.287469,-0.288006,-0.288543,-0.289080,-0.289617,-0.290153,-0.290690,-0.291227,-0.291764,-0.292300,-0.292837,-0.293374,-0.293910,-0.294447,-0.294984,-0.295520,-0.296057,-0.296593,-0.297130,-0.297666,-0.298203,-0.298740,-0.299276,-0.299812,-0.300349,-0.300885,-0.301422,-0.301958,-0.302494,-0.303031,-0.303567,-0.304103,-0.304640,-0.305176,-0.305712,-0.306248,-0.306784,-0.307321,-0.307857,-0.308393,-0.308929,-0.309465,-0.310001,-0.310537,-0.311073,-0.311609,-0.312145,-0.312680,-0.313216,-0.313752,-0.314288,-0.314824,-0.315359,-0.315895,-0.316430,-0.316966,-0.317502,-0.318037,-0.318573,-0.319108,-0.319643,-0.320179,-0.320714,-0.321250,-0.321785,-0.322320,-0.322855,-0.323390,-0.323925,-0.324461,-0.324996,-0.325531,-0.326065,-0.326600,-0.327135,-0.327670,-0.328205,-0.328740,-0.329274,-0.329809,-0.330343,-0.330878,-0.331413,-0.331947,-0.332481,-0.333016,-0.333550,-0.334084,-0.334619,-0.335153,-0.335687,-0.336221,-0.336755,-0.337289,-0.337823,-0.338357,-0.338890,-0.339424,-0.339958,-0.340492,-0.341025,-0.341559,-0.342092,-0.342626,-0.343159,-0.343692,-0.344225,-0.344759,-0.345292,-0.345825,-0.346358,-0.346891,-0.347424,-0.347957,-0.348489,-0.349022,-0.349555,-0.350087,-0.350620,-0.351152,-0.351685,-0.352217,-0.352749,-0.353282,-0.353814,-0.354346,-0.354878,-0.355410,-0.355942,-0.356473,-0.357005,-0.357537,-0.358068,-0.358600,-0.359131,-0.359663,-0.360194,-0.360725,-0.361256,-0.361787,-0.362318,-0.362849,-0.363380,-0.363911,-0.364442,-0.364972,-0.365503,-0.366033,-0.366564,-0.367094,-0.367624,-0.368154,-0.368684,-0.369214,-0.369744,-0.370274,-0.370804,-0.371334,-0.371863,-0.372393,-0.372922,-0.373451,-0.373981,-0.374510,-0.375039,-0.375568,-0.376097,-0.376625,-0.377154,-0.377683,-0.378211,-0.378740,-0.379268,-0.379796,-0.380324,-0.380852,-0.381380,-0.381908,-0.382436,-0.382964,-0.383491,-0.384019,-0.384546,-0.385074,-0.385601,-0.386128,-0.386655,-0.387182,-0.387708,-0.388235,-0.388762,-0.389288,-0.389815,-0.390341,0.015777,0.025388,0.030083,0.033515,0.036276,0.038605,0.040624,0.042409,0.044007,0.045452,0.046769,0.047978,0.049092,0.050123,0.051080,0.051972,0.052805,0.053583,0.054313,0.054998,0.055641,0.056246,0.056815,0.057352,0.057857,0.058333,0.058781,0.059204,0.059603,0.059979,0.060333,0.060666,0.060979,0.061274,0.061551,0.061810,0.062054,0.062281,0.062494,0.062692,0.062877,0.063048,0.063206,0.063352,0.063486,0.063608,0.063719,0.063820,0.063910,0.063990,0.064061,0.064121,0.064173,0.064216,0.064250,0.064276,0.064294,0.064303,0.064305,0.064300,0.064287,0.064267,0.064240,0.064207,0.064167,0.064120,0.064067,0.064008,0.063943,0.063872,0.063795,0.063713,0.063625,0.063532,0.063434,0.063330,0.063222,0.063108,0.062990,0.062867,0.062740,0.062608,0.062471,0.062330,0.062185,0.062036,0.061882,0.061724,0.061563,0.061397,0.061228,0.061055,0.060878,0.060698,0.060514,0.060327,0.060136,0.059941,0.059744,0.059543,0.059339,0.059131,0.058921,0.058707,0.058491,0.058271,0.058048,0.057823,0.057595,0.057364,0.057130,0.056893,0.056654,0.056412,0.056167,0.055920,0.055670,0.055418,0.055163,0.054906,0.054647,0.054385,0.054121,0.053854,0.053585,0.053314,0.053041,0.052765,0.052488,0.052208,0.051926,0.051642,0.051356,0.051068,0.050778,0.050486,0.050191,0.049895,0.049598,0.049298,0.048996,0.048693,0.048387,0.048080,0.047771,0.047461,0.047148,0.046834,0.046518,0.046201,0.045881,0.045561,0.045238,0.044914,0.044588,0.044261,0.043932,0.043602,0.043270,0.042937,0.042602,0.042265,0.041927,0.041588,0.041247,0.040905,0.040562,0.040217,0.039870,0.039523,0.039174,0.038823,0.038471,0.038118,0.037764,0.037408,0.037052,0.036693,0.036334,0.035973,0.035611,0.035248,0.034884,0.034519,0.034152,0.033784,0.033415,0.033045,0.032674,0.032301,0.031928,0.031553,0.031177,0.030801,0.030423,0.030044,0.029664,0.029283,0.028900,0.028517,0.028133,0.027748,0.027362,0.026974,0.026586,0.026197,0.025807,0.025416,0.025024,0.024631,0.024237,0.023842,0.023446,0.023049,0.022651,0.022253,0.021853,0.021453,0.021052,0.020650,0.020247,0.019843,0.019438,0.019033,0.018626,0.018219,0.017811,0.017402,0.016992,0.016582,0.016171,0.015758,0.015346,0.014932,0.014517,0.014102,0.013686,0.013269,0.012852,0.012434,0.012015,0.011595,0.011174,0.010753,0.010331,0.009909,0.009485,0.009061,0.008636,0.008211,0.007785,0.007358,0.006930,0.006502,0.006073,0.005644,0.005213,0.004782,0.004351,0.003919,0.003486,0.003052,0.002618,0.002183,0.001748,0.001312,0.000875,0.000438,0};
const float PDWave3LUT[] = {0.005028,0.005354,0.004452,0.003453,0.002683,0.001968,0.001094,0.000014,-0.001066,-0.002093,-0.003046,-0.004023,-0.005052,-0.006108,-0.007159,-0.008136,-0.009140,-0.010146,-0.011173,-0.012174,-0.013201,-0.014206,-0.015207,-0.016239,-0.017266,-0.018243,-0.019244,-0.020249,-0.021276,-0.022282,-0.023309,-0.024310,-0.025337,-0.026343,-0.027369,-0.028347,-0.029351,-0.030352,-0.031380,-0.032384,-0.033384,-0.034390,-0.035417,-0.036422,-0.037422,-0.038428,-0.039453,-0.040431,-0.041431,-0.042437,-0.043463,-0.044442,-0.045469,-0.046473,-0.047473,-0.048477,-0.049456,-0.050484,-0.051511,-0.052515,-0.053514,-0.054492,-0.055495,-0.056473,-0.057475,-0.058506,-0.059506,-0.060511,-0.061511,-0.062515,-0.063518,-0.064548,-0.065547,-0.066553,-0.067555,-0.068579,-0.069558,-0.070562,-0.071563,-0.072565,-0.073546,-0.074572,-0.075576,-0.076574,-0.077553,-0.078558,-0.079558,-0.080563,-0.081567,-0.082567,-0.083572,-0.084572,-0.085576,-0.086574,-0.087555,-0.088579,-0.089558,-0.090563,-0.091565,-0.092543,-0.093544,-0.094548,-0.095549,-0.096553,-0.097553,-0.098555,-0.099537,-0.100563,-0.101564,-0.102543,-0.103541,-0.104521,-0.105525,-0.106522,-0.107504,-0.108527,-0.109506,-0.110508,-0.111488,-0.112492,-0.113492,-0.114500,-0.115522,-0.116501,-0.117502,-0.118503,-0.119480,-0.120460,-0.121467,-0.122489,-0.123468,-0.124469,-0.125470,-0.126450,-0.127450,-0.128451,-0.129431,-0.130432,-0.131436,-0.132437,-0.133417,-0.134414,-0.135394,-0.136398,-0.137395,-0.138379,-0.139399,-0.140380,-0.141381,-0.142361,-0.143362,-0.144342,-0.145343,-0.146347,-0.147347,-0.148348,-0.149324,-0.150304,-0.151305,-0.152305,-0.153286,-0.154286,-0.155287,-0.156268,-0.157268,-0.158248,-0.159249,-0.160249,-0.161226,-0.162206,-0.163202,-0.164183,-0.165187,-0.166188,-0.167193,-0.168193,-0.169173,-0.170169,-0.171151,-0.172150,-0.173127,-0.174108,-0.175109,-0.176108,-0.177089,-0.178090,-0.179089,-0.180070,-0.181066,-0.182042,-0.183024,-0.184024,-0.185005,-0.186009,-0.187010,-0.188010,-0.188991,-0.189986,-0.190963,-0.191945,-0.192944,-0.193925,-0.194926,-0.195925,-0.196902,-0.197884,-0.198887,-0.199883,-0.200865,-0.201864,-0.202845,-0.203840,-0.204823,-0.205822,-0.206803,-0.207798,-0.208775,-0.209757,-0.210761,-0.211756,-0.212739,-0.213737,-0.214714,-0.215696,-0.216689,-0.217655,-0.218678,-0.219676,-0.220658,-0.221653,-0.222629,-0.223606,-0.224589,-0.225592,-0.226593,-0.227592,-0.228575,-0.229573,-0.230549,-0.231526,-0.232503,-0.233485,-0.234486,-0.235484,-0.236460,-0.237442,-0.238437,-0.239420,-0.240418,-0.241400,-0.242395,-0.243378,-0.244376,-0.245352,-0.246335,-0.247329,0.248312,0.247357,0.246387,0.245432,0.244455,0.243479,0.242508,0.241549,0.240573,0.239603,0.238654,0.237694,0.236718,0.235741,0.234772,0.233816,0.232840,0.231863,0.230886,0.229910,0.228940,0.227980,0.227011,0.226063,0.225107,0.224130,0.223154,0.222183,0.221224,0.220247,0.219279,0.218329,0.217369,0.216400,0.215436,0.214439,0.213471,0.212514,0.211538,0.210568,0.209616,0.208660,0.207683,0.206706,0.205737,0.204770,0.203784,0.202832,0.201875,0.200907,0.199942,0.198945,0.197977,0.197020,0.196044,0.195074,0.194114,0.193138,0.192170,0.191213,0.190236,0.189267,0.188306,0.187338,0.186372,0.185385,0.184428,0.183452,0.182482,0.181522,0.180545,0.179569,0.178601,0.177644,0.176676,0.175719,0.174742,0.173765,0.172789,0.171812,0.170836,0.169867,0.168906,0.167939,0.166972,0.165986,0.165028,0.164059,0.163090,0.162116,0.161164,0.160178,0.159220,0.158243,0.157267,0.156298,0.155337,0.154361,0.153384,0.152417,0.151449,0.150464,0.149506,0.148538,0.147568,0.146584,0.145623,0.144646,0.143670,0.142750,0.141773,0.140796,0.139820,0.138843,0.137867,0.136899,0.135937,0.134960,0.133984,0.133007,0.132031,0.131054,0.130088,0.129129,0.128153,0.127176,0.126208,0.125246,0.124270,0.123293,0.122317,0.121351,0.120392,0.119415,0.118438,0.117471,0.116509,0.115532,0.114556,0.113590,0.112631,0.111654,0.110677,0.109701,0.108724,0.107748,0.106771,0.105806,0.104846,0.103870,0.102902,0.101931,0.100949,0.099987,0.099010,0.098045,0.097085,0.096097,0.095115,0.094155,0.093179,0.092212,0.091249,0.090273,0.089296,0.088320,0.087343,0.086366,0.085401,0.084441,0.083465,0.082498,0.081535,0.080558,0.079572,0.078592,0.077629,0.076652,0.075676,0.074711,0.073751,0.072774,0.071798,0.070831,0.069868,0.068891,0.067915,0.066928,0.065948,0.064985,0.064008,0.063032,0.062055,0.061091,0.060130,0.059154,0.058177,0.057201,0.056224,0.055247,0.054283,0.053322,0.052346,0.051369,0.050393,0.049416,0.048440,0.047463,0.046497,0.045533,0.044557,0.043580,0.042604,0.041627,0.040651,0.039687,0.038725,0.037749,0.036772,0.035796,0.034819,0.033843,0.032877,0.031902,0.030924,0.029960,0.028996,0.028022,0.027030,0.026054,0.025077,0.024114,0.023152,0.022175,0.021199,0.020233,0.019258,0.018280,0.017305,0.016327,0.015363,0.014400,0.013424,0.012433,0.011457,0.010480,0.009503,0.008527,0.007564,0.006588,0.005597,0.004635,0.003672,0.002696,0.001719,0.000743,-0.000234,-0.001211,-0.002187,-0.003178,-0.004098,-0.005131,-0.006065,-0.007042,-0.008018,-0.008995,-0.009972,-0.010960,-0.011901,-0.012878,-0.013854,-0.014831,-0.015808,-0.016784,-0.017761,-0.018737,-0.019714,-0.020690,-0.021680,-0.022615,-0.023592,-0.024569,-0.025545,-0.026522,-0.027498,-0.028475,-0.029451,-0.030428,-0.031404,-0.032381,-0.033358,-0.034345,-0.035287,-0.036264,-0.037240,-0.038217,-0.039194,-0.040170,-0.041147,-0.042136,-0.043072,-0.044035,-0.045053,-0.046042,-0.046978,-0.047955,-0.048931,-0.049895,-0.050912,-0.051889,-0.052878,-0.053814,-0.054790,-0.055777,-0.056720,-0.057697,-0.058673,-0.059650,-0.060616,-0.061637,-0.062569,-0.063590,-0.064533,-0.065509,-0.066486,-0.067452,-0.068472,-0.069416,-0.070392,-0.071369,-0.072345,-0.073322,-0.074298,-0.075287,-0.076223,-0.077200,-0.078176,-0.079153,-0.080118,-0.081146,-0.082083,-0.083059,-0.084046,-0.084979,-0.085989,-0.086966,-0.087952,-0.088895,-0.089862,-0.090872,-0.091848,-0.092825,-0.093811,-0.094755,-0.095731,-0.096708,-0.097684,-0.098661,-0.099628,-0.100637,-0.101614,-0.102591,-0.103567,-0.104553,-0.105497,-0.106464,-0.107483,-0.108427,-0.109403,-0.110380,-0.111356,-0.112333,-0.113309,-0.114286,-0.115262,-0.116239,-0.117226,-0.118164,-0.119141,-0.120117,-0.121083,-0.122098,-0.123075,-0.124062,-0.125000,-0.125966,-0.126981,-0.127958,-0.128945,-0.129883,-0.130859,-0.131836,-0.132813,-0.133789,-0.134766,-0.135742,-0.136719,-0.137705,-0.138634,-0.139648,-0.140625,-0.141602,-0.142578,-0.143565,-0.144503,-0.145480,-0.146456,-0.147433,-0.148409,-0.149376,-0.150391,-0.151377,-0.152316,-0.153292,-0.154269,-0.155236,-0.156250,-0.157236,-0.158175,-0.159142,-0.160156,-0.161133,-0.162109,-0.163095,-0.164034,-0.165011,-0.165988,-0.166964,-0.167941,-0.168917,-0.169894,-0.170870,-0.171847,-0.172823,-0.173800,-0.174777,-0.175753,-0.176730,-0.177706,-0.178683,-0.179667,-0.180605,-0.181613,-0.182589,-0.183566,-0.184542,-0.185519,-0.186495,-0.187472,-0.188448,-0.189425,-0.190409,-0.191355,-0.192331,-0.193308,-0.194277,-0.195284,-0.196268,-0.197207,-0.198214,-0.199191,-0.200159,-0.201180,-0.202120,-0.203097,-0.204073,-0.205050,-0.206027,-0.207003,-0.207980,-0.208963,-0.209903,-0.210909,-0.211886,-0.212863,-0.213846,-0.214786,-0.215792,-0.216769,-0.217752,-0.218699,-0.219669,-0.220675,-0.221658,-0.222605,-0.223581,-0.224558,-0.225534,-0.226505,-0.227511,-0.228494,-0.229441,-0.230417,-0.231394,-0.232370,-0.233347,-0.234324,-0.235300,-0.236270,-0.237277,-0.238259,-0.239206,-0.240183,-0.241167,-0.242101,-0.243113,-0.244089,-0.245066,-0.246042,-0.247019,-0.247995,-0.248966,0.249978,0.248972,0.247995,0.247026,0.246007,0.245066,0.244089,0.243113,0.242136,0.241159,0.240177,0.239230,0.238253,0.237282,0.236277,0.235295,0.234352,0.233347,0.232370,0.231394,0.230424,0.229406,0.228464,0.227482,0.226534,0.225558,0.224587,0.223588,0.222570,0.221628,0.220652,0.219675,0.218699,0.217722,0.216740,0.215797,0.214792,0.213816,0.212839,0.211863,0.210886,0.209909,0.208933,0.207956,0.206980,0.206003,0.205027,0.204050,0.203074,0.202097,0.201120,0.200144,0.199167,0.198191,0.197214,0.196238,0.195261,0.194284,0.193303,0.192355,0.191378,0.190406,0.189402,0.188430,0.187415,0.186472,0.185495,0.184519,0.183542,0.182566,0.181589,0.180608,0.179664,0.178659,0.177683,0.176706,0.175726,0.174777,0.173804,0.172800,0.171824,0.170852,0.169838,0.168894,0.167913,0.166968,0.165964,0.164988,0.164011,0.163034,0.162058,0.161081,0.160105,0.159128,0.158152,0.157175,0.156199,0.155222,0.154242,0.153292,0.152316,0.151339,0.150363,0.149386,0.148409,0.147433,0.146460,0.145453,0.144507,0.143500,0.142550,0.141573,0.140600,0.139597,0.138620,0.137641,0.136694,0.135691,0.134714,0.133738,0.132758,0.131808,0.130834,0.129828,0.128878,0.127902,0.126925,0.125948,0.124972,0.123995,0.123019,0.122042,0.121066,0.120089,0.119113,0.118136,0.117159,0.116183,0.115206,0.114230,0.113253,0.112277,0.111300,0.110323,0.109347,0.108370,0.107394,0.106417,0.105438,0.104495,0.103488,0.102511,0.101534,0.100560,0.099556,0.098605,0.097628,0.096652,0.095675,0.094701,0.093696,0.092748,0.091743,0.090792,0.089816,0.088839,0.087863,0.086886,0.085909,0.084933,0.083956,0.082980,0.082001,0.081055,0.080078,0.079102,0.078127,0.077120,0.076142,0.075195,0.074221,0.073212,0.072238,0.071259,0.070314,0.069306,0.068359,0.067383,0.066408,0.065400,0.064455,0.063448,0.062472,0.061495,0.060519,0.059541,0.058594,0.057617,0.056641,0.055664,0.054688,0.053711,0.052734,0.051758,0.050780,0.049834,0.048828,0.047852,0.046875,0.045898,0.044922,0.043945,0.042970,0.041963,0.041017,0.040011,0.039033,0.038086,0.037109,0.036133,0.035156,0.034180,0.033202,0.032255,0.031279,0.030273,0.029297,0.028320,0.027344,0.026366,0.025419,0.024441,0.023517,0.022567,0.021449,0.019775,0.016492,0.009919,-0.001609,-0.019044,-0.041971,-0.068745,-0.097497,-0.126133,-0.151921,-0.169872,-0.172336,-0.158095,-0.134498,-0.107532,-0.080319,-0.054810,-0.032360,-0.014328,-0.001724,0.000977};
const float PDWave4LUT[] = {0.000594,0.000171,-0.000253,-0.000676,-0.001016,-0.001397,-0.001778,-0.002160,-0.002536,-0.002917,-0.003299,-0.003722,-0.004144,-0.004526,-0.004947,-0.005287,-0.005708,-0.006048,-0.006469,-0.006808,-0.007230,-0.007651,-0.007433,-0.007767,-0.008187,-0.008566,-0.008944,-0.009323,-0.009742,-0.010120,-0.010498,-0.010876,-0.011293,-0.011630,-0.012047,-0.012423,-0.012799,-0.013174,-0.013545,-0.013921,-0.014336,-0.014712,-0.015127,-0.015498,-0.015830,-0.016205,-0.016618,-0.016992,-0.017406,-0.017818,-0.018190,-0.018599,-0.018930,-0.019340,-0.019709,-0.020077,-0.020442,-0.020853,-0.021262,-0.021675,-0.022126,-0.022492,-0.022943,-0.023305,-0.023712,-0.024116,-0.023914,-0.024357,-0.024717,-0.025078,-0.025437,-0.025799,-0.026201,-0.026605,-0.027047,-0.027451,-0.027891,-0.028293,-0.028733,-0.029134,-0.029572,-0.029965,-0.030323,-0.030759,-0.031158,-0.031601,-0.032038,-0.032475,-0.032908,-0.033303,-0.033734,-0.034128,-0.034558,-0.034946,-0.035337,-0.035765,-0.036159,-0.036634,-0.037104,-0.037533,-0.037961,-0.038389,-0.038820,-0.039246,-0.039671,-0.040095,-0.040523,-0.040987,-0.041414,-0.041885,-0.042393,-0.042301,-0.042719,-0.043136,-0.043563,-0.044066,-0.044532,-0.045038,-0.045493,-0.045905,-0.046316,-0.046731,-0.047193,-0.047690,-0.048151,-0.048662,-0.049203,-0.049702,-0.050196,-0.050651,-0.051101,-0.051550,-0.052010,-0.052547,-0.053045,-0.053545,-0.054079,-0.054565,-0.055019,-0.055502,-0.055943,-0.056396,-0.056933,-0.057472,-0.058007,-0.058541,-0.059079,-0.059611,-0.060158,-0.060784,-0.061356,-0.061879,-0.062371,-0.062899,-0.063434,-0.063565,-0.064140,-0.064711,-0.065242,-0.065808,-0.066343,-0.066906,-0.067435,-0.068002,-0.068538,-0.069161,-0.069771,-0.070348,-0.070961,-0.071528,-0.072090,-0.072620,-0.073236,-0.073863,-0.074529,-0.075189,-0.075803,-0.076411,-0.076981,-0.077596,-0.078207,-0.078831,-0.079484,-0.080097,-0.080715,-0.081370,-0.081987,-0.082650,-0.083299,-0.083909,-0.084534,-0.085257,-0.086000,-0.086660,-0.087316,-0.087975,-0.088641,-0.089353,-0.090074,-0.090814,-0.091206,-0.091869,-0.092588,-0.093326,-0.094003,-0.094754,-0.095458,-0.096178,-0.096939,-0.097707,-0.098500,-0.099217,-0.099962,-0.100691,-0.101493,-0.102249,-0.103021,-0.103823,-0.104581,-0.105359,-0.106204,-0.106975,-0.107775,-0.108553,-0.109396,-0.110153,-0.110930,-0.111798,-0.112653,-0.113477,-0.114332,-0.115155,-0.116005,-0.116829,-0.117708,-0.118617,-0.119509,-0.120498,-0.121530,-0.122536,-0.123444,-0.124311,-0.125176,-0.126064,-0.126917,-0.127839,-0.128773,-0.129737,-0.130685,-0.131690,-0.132611,-0.133532,-0.134467,-0.135444,-0.136407,-0.137342,0.138318,0.137328,0.136324,0.135389,0.134426,0.133505,0.132569,0.131593,0.130630,0.129709,0.128788,0.127866,0.126945,0.126038,0.125158,0.124241,0.123335,0.122453,0.121546,0.120665,0.119743,0.118852,0.118010,0.117105,0.116242,0.115390,0.114563,0.113696,0.112846,0.112022,0.111185,0.110412,0.109583,0.108885,0.108033,0.107219,0.106423,0.105667,0.104908,0.104148,0.103389,0.102633,0.101872,0.101113,0.100340,0.099541,0.098797,0.098093,0.097384,0.096661,0.095919,0.095193,0.094432,0.093656,0.092872,0.092163,0.091472,0.090816,0.090161,0.089503,0.088831,0.088118,0.087407,0.086697,0.085985,0.085291,0.084629,0.083984,0.083379,0.082755,0.082091,0.081428,0.080767,0.080120,0.079493,0.078845,0.078233,0.077915,0.077265,0.076651,0.076052,0.075473,0.074874,0.074290,0.073691,0.073105,0.072523,0.071972,0.071351,0.070748,0.070177,0.069608,0.069054,0.068531,0.067993,0.067402,0.066794,0.066202,0.065593,0.065036,0.064509,0.063980,0.063453,0.062924,0.062410,0.061913,0.061400,0.060900,0.060348,0.059802,0.059299,0.058779,0.058276,0.057759,0.057252,0.056747,0.056289,0.055782,0.055259,0.054747,0.054225,0.053732,0.053763,0.053285,0.052837,0.052387,0.051937,0.051467,0.050982,0.050529,0.050058,0.049574,0.049117,0.048640,0.048136,0.047579,0.046914,0.046596,0.047963,0.053855,0.069703,0.101064,0.148962,0.209380,0.273073,0.300706,0.248008,0.177800,0.114002,0.066676,0.043123,0.037952,0.036427,0.035269,0.032930,0.029911,0.029565,0.030139,0.029693,0.029078,0.028379,0.027948,0.028104,0.028328,0.027962,0.027141,0.027028,0.026929,0.026664,0.026177,0.025628,0.025183,0.024880,0.024612,0.024280,0.023852,0.023408,0.023018,0.022668,0.022331,0.021939,0.021565,0.021197,0.020821,0.020452,0.020075,0.019685,0.019282,0.018928,0.018574,0.018219,0.017863,0.017506,0.017149,0.016791,0.016452,0.016119,0.015762,0.015382,0.014996,0.014615,0.014228,0.013846,0.013478,0.013138,0.012793,0.012470,0.012148,0.011807,0.011443,0.011075,0.011334,0.011008,0.010662,0.010292,0.009941,0.009635,0.009333,0.009004,0.008654,0.008281,0.007928,0.007598,0.007269,0.006919,0.006585,0.006275,0.005942,0.005609,0.005276,0.004924,0.004570,0.004235,0.003880,0.003543,0.003210,0.002875,0.002543,0.002205,0.001890,0.001554,0.001237,0.000945,0.000611,0.000252,-0.000086,-0.000424,-0.000762,-0.001100,-0.001437,-0.001752,-0.002090,-0.002471,-0.002831,-0.003170,-0.002891,-0.003865,-0.004162,-0.004438,-0.004777,-0.005118,-0.005430,-0.005832,-0.006192,-0.006469,-0.006808,-0.007127,-0.007552,-0.007821,-0.008181,-0.008457,-0.008816,-0.009115,-0.009384,-0.009703,-0.010124,-0.010400,-0.010758,-0.011036,-0.011347,-0.011727,-0.012127,-0.012464,-0.012801,-0.013158,-0.013435,-0.013744,-0.014143,-0.014459,-0.014876,-0.015149,-0.015506,-0.015772,-0.016126,-0.016378,-0.016755,-0.017150,-0.017483,-0.017838,-0.018101,-0.017811,-0.018185,-0.018559,-0.018932,-0.019324,-0.019675,-0.019935,-0.020263,-0.020572,-0.020923,-0.021316,-0.021753,-0.022289,-0.022701,-0.023151,-0.023475,-0.023799,-0.024104,-0.024489,-0.024814,-0.025128,-0.025430,-0.025794,-0.026176,-0.026476,-0.026820,-0.027243,-0.027585,-0.028008,-0.028367,-0.028707,-0.029149,-0.029418,-0.029819,-0.030238,-0.030593,-0.030948,-0.031302,-0.031655,-0.031971,-0.032429,-0.032843,-0.033175,-0.033587,-0.033917,-0.033681,-0.034090,-0.034417,-0.034806,-0.035195,-0.035564,-0.035996,-0.036464,-0.036804,-0.037125,-0.037509,-0.037855,-0.038346,-0.038772,-0.039216,-0.039577,-0.040001,-0.040425,-0.040829,-0.041333,-0.041726,-0.042036,-0.042409,-0.042743,-0.043213,-0.043676,-0.044156,-0.044588,-0.044956,-0.045304,-0.045698,-0.046155,-0.046592,-0.047120,-0.047575,-0.048047,-0.048454,-0.048841,-0.049293,-0.049743,-0.050174,-0.050695,-0.051143,-0.051608,-0.051458,-0.051882,-0.052399,-0.052841,-0.053265,-0.053736,-0.054270,-0.054831,-0.055299,-0.055849,-0.056323,-0.056874,-0.057374,-0.057790,-0.058269,-0.058739,-0.059268,-0.059793,-0.060328,-0.060854,-0.061397,-0.061852,-0.062401,-0.062874,-0.063346,-0.063781,-0.064359,-0.064926,-0.065520,-0.066038,-0.066536,-0.067110,-0.067676,-0.068240,-0.068829,-0.069325,-0.069886,-0.070439,-0.071067,-0.071635,-0.072196,-0.072753,-0.073303,-0.073927,-0.074475,-0.074669,-0.075276,-0.075880,-0.076477,-0.077132,-0.077814,-0.078433,-0.078975,-0.079575,-0.080168,-0.080804,-0.081535,-0.082203,-0.082810,-0.083408,-0.083981,-0.084683,-0.085409,-0.086051,-0.086768,-0.087425,-0.088072,-0.088712,-0.089411,-0.090135,-0.090773,-0.091471,-0.092163,-0.092915,-0.093690,-0.094381,-0.095132,-0.095907,-0.096596,-0.097347,-0.098121,-0.098809,-0.099559,-0.100300,-0.101127,-0.101902,-0.102564,-0.103390,-0.104148,-0.104730,-0.105469,-0.106281,-0.107068,-0.107965,-0.108688,-0.109553,-0.110420,-0.111293,-0.112087,-0.112967,-0.113761,-0.114643,-0.115429,-0.116293,-0.117158,-0.118008,-0.118943,-0.119807,-0.120673,-0.121530,-0.122379,-0.123300,-0.124205,-0.125211,-0.126046,-0.127037,-0.127957,-0.128892,-0.129727,-0.130718,-0.131624,-0.132601,-0.133563,0.134610,0.133620,0.132727,0.131694,0.130662,0.129615,0.128624,0.127704,0.126784,0.125864,0.124957,0.124037,0.123047,0.122127,0.121193,0.120342,0.119422,0.118487,0.117643,0.116697,0.115902,0.115024,0.114241,0.113281,0.112561,0.111697,0.110832,0.109954,0.109144,0.108354,0.107477,0.106680,0.105802,0.104979,0.104244,0.103434,0.102611,0.101867,0.101052,0.100296,0.099552,0.098739,0.097924,0.097167,0.096398,0.095703,0.095011,0.094253,0.093502,0.092744,0.091984,0.091233,0.090463,0.089768,0.089005,0.088558,0.087913,0.087259,0.086623,0.085914,0.085213,0.084495,0.083839,0.083190,0.082543,0.081820,0.081235,0.080511,0.079915,0.079254,0.078656,0.078003,0.077342,0.076679,0.076069,0.075467,0.074856,0.074252,0.073640,0.073036,0.072422,0.071825,0.071141,0.070585,0.070028,0.069472,0.068854,0.068288,0.067736,0.067117,0.066548,0.065979,0.065468,0.064904,0.064340,0.063761,0.063253,0.062687,0.062105,0.061595,0.061470,0.060949,0.060429,0.059901,0.059378,0.058862,0.058268,0.057792,0.057315,0.056846,0.056312,0.055777,0.055296,0.054809,0.054377,0.053894,0.053417,0.052878,0.052386,0.051900,0.051412,0.050918,0.050478,0.050030,0.049594,0.049102,0.048610,0.048118,0.047612,0.047177,0.046616,0.046221,0.045771,0.045309,0.044911,0.044453,0.044052,0.043592,0.043190,0.042734,0.042272,0.041867,0.041392,0.041036,0.041127,0.040768,0.040296,0.039929,0.039511,0.039092,0.038672,0.038256,0.037785,0.037352,0.036980,0.036551,0.036172,0.035792,0.035415,0.034988,0.034556,0.034172,0.033784,0.033448,0.033061,0.032679,0.032246,0.031809,0.031420,0.031030,0.030631,0.030337,0.029941,0.029596,0.029202,0.028803,0.028461,0.028062,0.027713,0.027312,0.026965,0.026516,0.026161,0.025808,0.025404,0.025047,0.024686,0.024374,0.024014,0.024272,0.023862,0.023549,0.023140,0.022782,0.022418,0.022054,0.021689,0.021324,0.020955,0.020630,0.020354,0.019986,0.019620,0.019206,0.018840,0.018515,0.018141,0.017861,0.017490,0.017118,0.016744,0.016415,0.016090,0.015759,0.015429,0.015097,0.014768,0.014391,0.014060,0.013685,0.013314,0.012937,0.012603,0.012269,0.011932,0.011686,0.011312,0.010979,0.010556,0.010219,0.009926,0.009589,0.009294,0.009603,0.009222,0.008885,0.008547,0.008208,0.007918,0.007581,0.007200,0.006819,0.006438,0.006099,0.005802,0.005510,0.005171,0.004833,0.004451,0.004112,0.003730,0.003391,0.003098,0.002803,0.001953,0.000977};
const float PDWave5LUT[] = {0.002996,0.005019,0.007045,0.009074,0.011107,0.013145,0.015191,0.020278,0.022350,0.024432,0.026528,0.028637,0.030761,0.032902,0.035061,0.037239,0.039439,0.041662,0.043910,0.046184,0.048488,0.050822,0.053190,0.059010,0.061495,0.064025,0.066603,0.069234,0.071922,0.074671,0.077488,0.080377,0.083347,0.086405,0.089559,0.092821,0.096201,0.099715,0.103378,0.112215,0.116474,0.121001,0.125851,0.131099,0.136849,0.143264,0.150217,0.149538,0.155373,0.159080,0.156494,0.152900,0.149978,0.147383,0.144327,0.138182,0.135051,0.131985,0.129052,0.126016,0.122975,0.119990,0.117197,0.114451,0.111810,0.109067,0.106428,0.103880,0.101310,0.098820,0.094885,0.092415,0.090016,0.087637,0.085281,0.083001,0.080680,0.078424,0.076134,0.073913,0.071711,0.069515,0.067336,0.065215,0.063066,0.060965,0.057732,0.055661,0.053563,0.051515,0.049474,0.047443,0.045435,0.043508,0.041503,0.039545,0.037555,0.035621,0.033687,0.031759,0.029837,0.027922,0.025135,0.023235,0.021345,0.019502,0.017663,0.015792,0.013997,0.012135,0.010353,0.008545,0.006770,0.004964,0.003196,0.001393,-0.000396,-0.002149,-0.004711,-0.006454,-0.008194,-0.009926,-0.011655,-0.013350,-0.015074,-0.016758,-0.018440,-0.020155,-0.021833,-0.023513,-0.025221,-0.026890,-0.028553,-0.030941,-0.032567,-0.034226,-0.035878,-0.037488,-0.039107,-0.040754,-0.042369,-0.044012,-0.045623,-0.047252,-0.048821,-0.050423,-0.052018,-0.053583,-0.055180,-0.057350,-0.058937,-0.060495,-0.062080,-0.063630,-0.065174,-0.066722,-0.068275,-0.069847,-0.071359,-0.072902,-0.074438,-0.075942,-0.077482,-0.079021,-0.080559,-0.082610,-0.084103,-0.085606,-0.087132,-0.088627,-0.090121,-0.091614,-0.093105,-0.094592,-0.096083,-0.097572,-0.099048,-0.100476,-0.101957,-0.103412,-0.104894,-0.106844,-0.108297,-0.109774,-0.111213,-0.112629,-0.114073,-0.115520,-0.116986,-0.118400,-0.119842,-0.121284,-0.122718,-0.124122,-0.125522,-0.126940,-0.128834,-0.130265,-0.131667,-0.133075,-0.134503,-0.135893,-0.137265,-0.138664,-0.140064,-0.141462,-0.142868,-0.144287,-0.145655,-0.147041,-0.148410,-0.149806,-0.151586,-0.152974,-0.154333,-0.155693,-0.157051,-0.158413,-0.159799,-0.161158,-0.162516,-0.163873,-0.165231,-0.166580,-0.167917,-0.169292,-0.170617,-0.171966,-0.173673,-0.175020,-0.176340,-0.177668,-0.179015,-0.180341,-0.181675,-0.182976,-0.184321,-0.185640,-0.186958,-0.188277,-0.189595,-0.190913,-0.192238,-0.193573,-0.195208,-0.196543,-0.197826,-0.199116,-0.200424,-0.201715,-0.203022,-0.204313,-0.205610,-0.206871,-0.208186,-0.209501,0.210808,0.210127,0.209429,0.209060,0.208387,0.207714,0.207040,0.206363,0.205690,0.205016,0.204343,0.203669,0.202986,0.202288,0.201605,0.200906,0.200222,0.199522,0.198835,0.198403,0.197728,0.197044,0.196336,0.195627,0.194927,0.194233,0.193509,0.192824,0.192105,0.191377,0.190692,0.189982,0.189273,0.188554,0.187820,0.187343,0.186624,0.185900,0.185204,0.184468,0.183745,0.183011,0.182291,0.181547,0.180813,0.180093,0.179349,0.178615,0.177894,0.177150,0.176416,0.175927,0.175171,0.174411,0.173679,0.172922,0.172200,0.171456,0.170711,0.169967,0.169212,0.168444,0.167689,0.166932,0.166199,0.165432,0.164880,0.164125,0.163357,0.162601,0.161823,0.161056,0.160300,0.159532,0.158776,0.158008,0.157252,0.156474,0.155695,0.154917,0.154148,0.153388,0.152807,0.152029,0.151250,0.150471,0.149681,0.148881,0.148102,0.147334,0.146555,0.145733,0.144965,0.144197,0.143396,0.142617,0.141825,0.141022,0.140407,0.139617,0.138816,0.138026,0.137225,0.136434,0.135622,0.134822,0.134043,0.133240,0.132419,0.131628,0.130827,0.130036,0.129236,0.128432,0.127760,0.126959,0.126168,0.125356,0.124544,0.123731,0.122919,0.122107,0.121295,0.120482,0.119670,0.118846,0.118013,0.117188,0.116355,0.115707,0.114895,0.114068,0.113232,0.112408,0.111575,0.110750,0.109917,0.109105,0.108280,0.107447,0.106622,0.105790,0.104964,0.104119,0.103287,0.102593,0.101760,0.100935,0.100089,0.099257,0.098432,0.097586,0.096739,0.095904,0.095065,0.094200,0.093355,0.092523,0.091697,0.090852,0.089993,0.089292,0.088447,0.087602,0.086743,0.085878,0.085033,0.084188,0.083329,0.082478,0.081651,0.080792,0.079928,0.079083,0.078237,0.077378,0.076512,0.075762,0.074903,0.074053,0.073212,0.072334,0.071470,0.070610,0.069732,0.068868,0.068009,0.067145,0.066285,0.065421,0.064561,0.063683,0.062936,0.062058,0.061180,0.060316,0.059456,0.058578,0.057715,0.056840,0.055958,0.055098,0.054235,0.053358,0.052459,0.051581,0.050703,0.049839,0.049045,0.048182,0.047321,0.046443,0.045565,0.044687,0.043809,0.042915,0.042020,0.041141,0.040263,0.039385,0.038492,0.037611,0.036751,0.035857,0.035043,0.034182,0.033288,0.032393,0.031515,0.030637,0.029743,0.028832,0.027937,0.027058,0.026165,0.025267,0.024387,0.023493,0.022598,0.021720,0.020907,0.020013,0.019118,0.018224,0.017313,0.016418,0.015524,0.014629,0.013735,0.012824,0.011913,0.011002,0.010107,0.009229,0.008335,0.007506,0.006497,0.005635,0.004724,0.003813,0.002902,0.001991,0.001064,0.000202,-0.000709,-0.001619,-0.002530,-0.003441,-0.004368,-0.005246,-0.006108,-0.006921,-0.007832,-0.008772,-0.009608,-0.010502,-0.011347,-0.012193,-0.013006,-0.013933,-0.014826,-0.015656,-0.016550,-0.017379,-0.018273,-0.019102,-0.019996,-0.020710,-0.021570,-0.022352,-0.023260,-0.024073,-0.024885,-0.025697,-0.026509,-0.027306,-0.028167,-0.028977,-0.029796,-0.030623,-0.031387,-0.032199,-0.032996,-0.033659,-0.034486,-0.035265,-0.036029,-0.036856,-0.037635,-0.038400,-0.039226,-0.040035,-0.040719,-0.041481,-0.042314,-0.043093,-0.043887,-0.044633,-0.045379,-0.045927,-0.046658,-0.047452,-0.048197,-0.048943,-0.049689,-0.050434,-0.051180,-0.051924,-0.052690,-0.053389,-0.054148,-0.054847,-0.055606,-0.056304,-0.056772,-0.057578,-0.058276,-0.059049,-0.059700,-0.060471,-0.061143,-0.061841,-0.062613,-0.063278,-0.063976,-0.064734,-0.065446,-0.066158,-0.066869,-0.067594,-0.067958,-0.068690,-0.069368,-0.070045,-0.070723,-0.071401,-0.072078,-0.072729,-0.073500,-0.074177,-0.074854,-0.075516,-0.076246,-0.076923,-0.077587,-0.078310,-0.078687,-0.079364,-0.080027,-0.080762,-0.081392,-0.082079,-0.082716,-0.083391,-0.084067,-0.084743,-0.085418,-0.086093,-0.086769,-0.087456,-0.088098,-0.088726,-0.089138,-0.089825,-0.090466,-0.091106,-0.091759,-0.092353,-0.092981,-0.093655,-0.094341,-0.094979,-0.095625,-0.096264,-0.096891,-0.097551,-0.098282,-0.098583,-0.099221,-0.099860,-0.100471,-0.101208,-0.101833,-0.102517,-0.103154,-0.103803,-0.104382,-0.105065,-0.105701,-0.106325,-0.107006,-0.107648,-0.108272,-0.108635,-0.109316,-0.109951,-0.110597,-0.111197,-0.111786,-0.112395,-0.113127,-0.113749,-0.114393,-0.115130,-0.115877,-0.116590,-0.117269,-0.117901,-0.118545,-0.118819,-0.119446,-0.120123,-0.120754,-0.121374,-0.122039,-0.122715,-0.123334,-0.124009,-0.124650,-0.125232,-0.125856,-0.126531,-0.127137,-0.127857,-0.128463,-0.128858,-0.129542,-0.130112,-0.130783,-0.131406,-0.132067,-0.132749,-0.133329,-0.133954,-0.134569,-0.135218,-0.135913,-0.136629,-0.137242,-0.137910,-0.138201,-0.138916,-0.139528,-0.140196,-0.140797,-0.141489,-0.142181,-0.142874,-0.143566,-0.144266,-0.144929,-0.145584,-0.146229,-0.146930,-0.147575,-0.148275,-0.148561,-0.149251,-0.149940,-0.150629,-0.151317,-0.152012,-0.152710,-0.153352,-0.154050,-0.154692,-0.155379,-0.156076,-0.156707,-0.157430,-0.158162,-0.158848,-0.159249,-0.159934,-0.160609,-0.161331,-0.162062,-0.162746,-0.163411,-0.164187,-0.164861,-0.165591,-0.166255,-0.167030,-0.167702,-0.168419,-0.169174,-0.169939,-0.170474,-0.171183,-0.171938,-0.172702,0.173420,0.172184,0.170957,0.169666,0.168485,0.167193,0.166001,0.164761,0.163561,0.162361,0.161161,0.159774,0.158573,0.157372,0.156162,0.154998,0.153843,0.152641,0.151431,0.150275,0.149064,0.147899,0.146733,0.145575,0.144410,0.143253,0.142033,0.140671,0.139597,0.138423,0.137312,0.136091,0.134971,0.133797,0.132676,0.131510,0.130335,0.129214,0.128039,0.126910,0.125765,0.124729,0.123591,0.122353,0.121278,0.120087,0.119041,0.117958,0.116828,0.115691,0.114599,0.113507,0.112416,0.111317,0.110271,0.109186,0.108049,0.106949,0.105888,0.104804,0.103758,0.102658,0.101605,0.100551,0.099490,0.098475,0.097467,0.096421,0.095328,0.094229,0.093175,0.092115,0.091099,0.090091,0.088992,0.087976,0.086954,0.085985,0.084969,0.083948,0.082978,0.081956,0.080979,0.080009,0.078994,0.077972,0.076996,0.076013,0.075075,0.074143,0.073173,0.072145,0.071214,0.070237,0.069248,0.068355,0.067417,0.066485,0.065503,0.064565,0.063621,0.062733,0.061751,0.060819,0.059837,0.058893,0.058071,0.057177,0.056234,0.055334,0.054429,0.053568,0.052713,0.051819,0.050875,0.049976,0.049071,0.048205,0.047392,0.046482,0.045665,0.044803,0.044018,0.043162,0.042252,0.041429,0.040611,0.039744,0.038925,0.038064,0.037197,0.036374,0.035544,0.034720,0.033892,0.033110,0.032286,0.031609,0.030823,0.030037,0.029250,0.028467,0.027634,0.026893,0.026068,0.025239,0.024448,0.023702,0.022914,0.022127,0.021335,0.020585,0.019825,0.019303,0.018552,0.017805,0.017012,0.016257,0.015546,0.014794,0.014045,0.013249,0.012537,0.011781,0.011069,0.010309,0.009638,0.008872,0.008196,0.007739,0.007028,0.006230,0.005510,0.004829,0.004148,0.003464,0.002825,0.002103,0.001424,0.000696,0.000014,-0.000669,-0.001352,-0.002036,-0.002720,-0.003114,-0.003760,-0.004447,-0.005096,-0.005742,-0.006436,-0.007088,-0.007701,-0.008313,-0.008964,-0.009615,-0.010264,-0.010951,-0.011641,-0.012295,-0.012558,-0.013173,-0.013826,-0.014482,-0.015100,-0.015716,-0.016373,-0.016994,-0.017576,-0.018194,-0.018858,-0.019442,-0.020064,-0.020650,-0.021234,-0.021856,-0.022090,-0.022714,-0.023307,-0.023895,-0.024484,-0.025072,-0.025699,-0.026252,-0.026843,-0.027398,-0.027989,-0.028550,-0.029140,-0.029769,-0.030325,-0.030953,-0.031200,-0.031722,-0.032317,-0.032881,-0.033475,-0.034113,-0.034319,-0.032140,-0.029981,-0.027840,-0.025716,-0.023607,-0.021512,-0.019429,-0.017357,-0.015296,-0.010225,-0.008186,-0.006153,-0.004124,-0.002099,-0.000075,0.001953,0.000977};

// Create an array of pointers to the PD LUTs
const float * LUTArray[] = { PDSawLUT, PDSquareLUT, PDWave3LUT, PDWave4LUT, PDWave5LUT };
uint8_t NoOfLUTs = sizeof(LUTArray) / sizeof(LUTArray[0]);

//	Use extern C to allow linker to find ISR
extern "C"
{
	void TIM3_IRQHandler(void) {
		// Send next samples to DAC
		if (TIM3->SR & TIM_SR_UIF) 						// if UIF flag is set
		{
			TIM3->SR &= ~TIM_SR_UIF;					// clear UIF flag
			DAC->SWTRIGR |= DAC_SWTRIGR_SWTRIG1;		// Tell the DAC to output the next value
			DAC->SWTRIGR |= DAC_SWTRIGR_SWTRIG2;		// Tell the DAC to output the next value

			if (DacRead == 1)							// If the buffer has not been refilled increment overrun warning
				overrun++;

			DacRead = 1;
		}
	}
}


//	Interpolate between two positions (derived from a float and its rounded value) in a LUT
float Interpolate(float* LUT, float& LUTPosition)
{
	float s1 = LUT[(int) LUTPosition];
	float s2 = LUT[((int) LUTPosition + 1) % LUTSIZE];
	return s1 + ((s2 - s1) * (LUTPosition - (int)LUTPosition));
}

// Generate a phase distorted sine wave - pass LUT containing PD offsets, LUT position as a fraction of the wave cycle and a scaling factor
float GetPhaseDist(const float* PdLUT, const float LUTPosition, float scale = 1, float offset = 0){
	PhaseDist = PdLUT[(int)(LUTPosition * LUTSIZE)] * LUTSIZE * scale;

	// Add main wave position to phase distortion position and ensure in bounds
	float Pos = ((LUTPosition + offset) * LUTSIZE) + PhaseDist;
	while (Pos > LUTSIZE)
		Pos -= LUTSIZE;
	while (Pos < 0)
		Pos =  LUTSIZE + Pos;

	return Interpolate(SineLUT, Pos); 	//	interpolate samples
}

// Generate a phase distorted sine wave - pass LUT containing PD offsets, LUT position as a fraction of the wave cycle and a scaling factor
float GetBlendPhaseDist(float PDBlend, const float LUTPosition, float scale = 1, float offset = 0){
	// get the two PD LUTs that will be blended
	const float* PdLUTBlendA = LUTArray[(uint8_t)PDBlend];
	const float* PdLUTBlendB = LUTArray[(uint8_t)(PDBlend + 1) % NoOfLUTs];

	// Get the values from each LUT for the sample position
	float PhaseDistA = PdLUTBlendA[(int)(LUTPosition * LUTSIZE)] * LUTSIZE * scale;
	float PhaseDistB = PdLUTBlendB[(int)(LUTPosition * LUTSIZE)] * LUTSIZE * scale;

	// Get the weighted blend of the two PD amounts
	float blend = PDBlend - (uint8_t)PDBlend;
	PhaseDist = ((1 - blend) * PhaseDistA) + (blend * PhaseDistB);

	// Add main wave position to phase distortion position and ensure in bounds
	float Pos = ((LUTPosition + offset) * LUTSIZE) + PhaseDist;
	while (Pos > LUTSIZE)
		Pos -= LUTSIZE;
	while (Pos < 0)
		Pos =  LUTSIZE + Pos;

	return Interpolate(SineLUT, Pos); 	//	interpolate samples
}

void CreateLUTs(void)
{
	// Generate pitch lookup table
	for (int p = 0; p < LUTSIZE; p++){
		float power = (float)(p * 4.0f) / -585.0f;
		PitchLUT[p] = 2272 * (float)std::pow(2.0f, power);
	}

	// Generate Sine LUT
	for (int s = 0; s < LUTSIZE; s++){
		SineLUT[s] = sin(s * 2.0f * M_PI / LUTSIZE);
	}

	// Generate Triangle LUT
	for (int s = 0; s < LUTSIZE; s++){
		float slope = 4 * (float)s / (float)LUTSIZE;

		if 			(s <= LUTSIZE / 4)		{	TriLUT[s] = slope;
		} else if 	(s <= 3 * LUTSIZE / 4)	{	TriLUT[s] = 2.0f - slope;
		} else		{			TriLUT[s] = slope - 4;
		}
	}

	// Generate curvy triangle LUT
	for (int s = 0; s < LUTSIZE; s++){
		float slope = cos(2.0f * M_PI * (float)s / (float)LUTSIZE);

		if 			(s <= LUTSIZE / 4)		{	CTriLUT[s] = -1 * (slope - 1);
		} else if 	(s <= LUTSIZE / 2)		{	CTriLUT[s] = slope + 1;
		} else if 	(s <= 3 * LUTSIZE / 4)	{	CTriLUT[s] = -1 * (slope + 1);
		} else {								CTriLUT[s] = slope - 1;
		}
	}
}


int main(void)
{
	SystemInit();				// Activates floating point coprocessor and resets clock
	SystemClock_Config();		// Configure the clock and PLL
	SystemCoreClockUpdate();	// Update SystemCoreClock, which is the system clock frequency supplied to the SysTick timer and the processor core clock. This variable can be used by debuggers to query the frequency of the debug timer or to configure the trace clock speed.

	CreateLUTs();				// Create pitch and sine wave look up tables
	InitIO();					// PC6 Button in (Ring mod)
	InitDAC();					// DAC1 Output on PA4 (A2); DAC2 Output on PA5 (D13)
	InitTimer();				// Sample output timer 3 - fires interrupt to trigger sample output from DAC
	InitADC();					// ADC for reading pitch on PB0 (A3); PD CV on PB1 (A1); DAC1 Type Pot on PA1;  DAC2 Type Pot on PA2

	float oldOutput1 =  0;
	float oldOutput2 = 0;

	RelativePitch RelPitch = OCTAVEDOWN;


	while (1)
	{
		// Get Pitch from ADC and smooth
		Pitch = (0.5f * Pitch) + (0.5f * ADC_array[0]);

		// Selected PD LUT

		SelPDLut1 = (float)ADC_array[2] * NoOfLUTs / 4096;
		PDLut2 = ADC_array[3] * NoOfLUTs / 4096;

		// Ready for next sample
		if (DacRead)
		{
			// Get modulation from ADC; Currently seeing 0v as ~3000 and 5V as ~960
			PDScale = (float)(3800 - ADC_array[1]) / 800;

			// Calculate output as a float from -1 to +1 checking phase distortion and phase offset as required
			float SampleOut1 = GetBlendPhaseDist(SelPDLut1, SamplePos1 / SAMPLERATE, PDScale, 0);	//PDScale
			float SampleOut2 = GetPhaseDist(LUTArray[PDLut2], SamplePos2 / SAMPLERATE, 1, 0);

			// Set DAC output values for when sample interrupt next fires
			if (RingModOn) {
				DAC->DHR12R1 = (int)((1 + (SampleOut1 * SampleOut2)) * 2047);		// Ring mod of 1 * 2
			} else {
				DAC->DHR12R1 = (int)((1 + SampleOut1) * 2047);		// load the next sample into the DAC 1 buffer
			}
			DAC->DHR12R2 = (int)((1 + SampleOut2) * 2047);		// load the next sample into the DAC 2 buffer

//			DAC->DHR12R1 = (int)((1 + (SampleOut1 * (-1 * SampleOut2))) * 2047);	// Ring mod of 1 * 2'
//			DAC->DHR12R1 = (int)(((2 + SampleOut1 + SampleOut2) / 2) * 2047);		// Mix of 1 + 2
//			DAC->DHR12R2 = (int)((1 + (-1 * SampleOut2)) * 2047);					// DAC 2 - inverted
			DacRead = 0;

			oldOutput1 = SampleOut1;
			oldOutput2 = SampleOut2;

			freq1 = PitchLUT[Pitch / 4];		// divide by four as there are 1024 items in DAC CV Voltage to Pitch Freq LUT and 4096 possible DAC voltage values

			// octave down
			switch(RelPitch) {
				case NONE: 			freq2 = freq1; 		break;
				case OCTAVEDOWN:	freq2 = freq1 / 2;	break;
				case OCTAVEUP: 		freq2 = freq1 * 2;	break;
				case SPREAD: 		freq2 = freq1 + 10;	break;
			}

			// jump forward to the next sample position
			SamplePos1 += freq1;
			while (SamplePos1 >= SAMPLERATE)
				SamplePos1-= SAMPLERATE;

			SamplePos2 += freq2;
			while (SamplePos2 >= SAMPLERATE)
				SamplePos2-= SAMPLERATE;
		}

		// Toggle Ring mod when button pressed
		if (!READ_BIT(GPIOC->IDR, GPIO_IDR_IDR_6)) {
			if (!ButtonDown) {
				RingModOn = !RingModOn;
				ButtonDown = true;
			}
		} else {
			ButtonDown = false;
		}
	}
}
